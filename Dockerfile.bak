# Dockerfile for icn-covm-v3 (ICN Runtime)

# Build Stage
FROM rust:1.81-slim-bullseye as builder

WORKDIR /usr/src/app

# Install necessary build dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    pkg-config libssl-dev build-essential

# Copy the entire project context (respecting .dockerignore)
COPY . .

# Build the release binary for the CLI
# Ensure the binary target name 'covm' matches your cli/Cargo.toml
RUN cargo build --release --bin covm

# Runtime Stage
FROM debian:bullseye-slim as runtime

# Install runtime dependencies
RUN apt-get update && apt-get install -y --no-install-recommends \
    ca-certificates libssl1.1 curl bash && \
    rm -rf /var/lib/apt/lists/*

# Create necessary directories
RUN mkdir -p /app/logs /app/data /app/scripts /app/config

# Copy the compiled binary
COPY --from=builder /usr/src/app/target/release/covm /usr/local/bin/covm

# Copy scripts and make executable (Corrected Paths based on ls output)
COPY ./run_integration_node.sh /app/scripts/    # Script is in the root
COPY ./monitor_integration.sh /app/scripts/    # Script is in the root
COPY ./tests/reset_icn_state.sh /app/scripts/ # Script is in tests/
RUN chmod +x /app/scripts/*.sh

# Copy config directory
COPY ./config /app/config

# Set working directory
WORKDIR /app

# Expose necessary ports
EXPOSE 8080
EXPOSE 8090
EXPOSE 4001

# Define the default command
CMD ["/app/scripts/run_integration_node.sh"]
